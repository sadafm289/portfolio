<!-- ============================= -->
<!--   SELECTIVE SYNC MODAL        -->
<!-- ============================= -->
<div id="selective-sync-modal" class="calendar-action-modal">
  <div class="calendar-action-modal-content">
    <div class="calendar-action-modal-header">
      <h2><i class="fas fa-calendar-plus"></i> Sync to Calendar</h2>
      <button id="close-selective-sync-modal" class="close-btn">&times;</button>
    </div>
    
    <div class="calendar-action-modal-body">
      <!-- Sprint Info -->
      <div class="sync-modal-sprint-info">
        <span class="sync-modal-sprint-name" id="sync-modal-sprint-name"></span>
        <span class="sync-modal-date-range" id="sync-modal-date-range"></span>
      </div>
      
      <!-- Warnings Section -->
      <div id="sync-warnings-container" class="sync-warnings-container hidden"></div>
      
      <!-- Quick Actions -->
      <div class="sync-quick-actions">
        <button type="button" class="quick-action-btn" id="sync-select-all"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" class="quick-action-btn" id="sync-deselect-all"><i class="fas fa-square"></i> Deselect All</button>
        <button type="button" class="quick-action-btn" id="sync-select-formative"><i class="fas fa-book"></i> Formative Only</button>
        <button type="button" class="quick-action-btn" id="sync-select-summative"><i class="fas fa-clipboard-check"></i> Summative Only</button>
      </div>
      
      <!-- Priority Selector -->
      <div class="sync-modal-priority">
        <label class="priority-label">Priority Level:</label>
        <div class="priority-options-inline">
          <label class="priority-option-inline"><input type="radio" name="sync-modal-priority" value="P0"><span class="priority-badge p0">P0</span></label>
          <label class="priority-option-inline"><input type="radio" name="sync-modal-priority" value="P1"><span class="priority-badge p1">P1</span></label>
          <label class="priority-option-inline"><input type="radio" name="sync-modal-priority" value="P2" checked><span class="priority-badge p2">P2</span></label>
          <label class="priority-option-inline"><input type="radio" name="sync-modal-priority" value="P3"><span class="priority-badge p3">P3</span></label>
        </div>
      </div>
      
      <!-- Week Selection List -->
      <div class="sync-week-list" id="sync-week-list">
        <!-- Dynamically populated -->
      </div>
      
      <!-- Summary -->
      <div class="sync-summary" id="sync-summary">
        <span class="sync-summary-count"><span id="sync-selected-count">0</span> items selected</span>
      </div>
    </div>
    
    <div class="calendar-action-modal-footer">
      <button type="button" class="modal-btn secondary" id="cancel-selective-sync">Cancel</button>
      <button type="button" class="modal-btn primary" id="confirm-selective-sync"><i class="fas fa-sync"></i> Sync Selected</button>
    </div>
  </div>
</div>

<!-- ============================= -->
<!--   SELECTIVE REMOVE MODAL      -->
<!-- ============================= -->
<div id="selective-remove-modal" class="calendar-action-modal">
  <div class="calendar-action-modal-content remove-modal">
    <div class="calendar-action-modal-header">
      <h2><i class="fas fa-calendar-minus"></i> Remove from Calendar</h2>
      <button id="close-selective-remove-modal" class="close-btn">&times;</button>
    </div>
    
    <div class="calendar-action-modal-body">
      <!-- Sprint Info -->
      <div class="sync-modal-sprint-info">
        <span class="sync-modal-sprint-name" id="remove-modal-sprint-name"></span>
        <span class="sync-modal-date-range" id="remove-modal-date-range"></span>
      </div>
      
      <!-- Quick Actions -->
      <div class="sync-quick-actions">
        <button type="button" class="quick-action-btn" id="remove-select-all"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" class="quick-action-btn" id="remove-deselect-all"><i class="fas fa-square"></i> Deselect All</button>
        <button type="button" class="quick-action-btn" id="remove-select-formative"><i class="fas fa-book"></i> Formative Only</button>
        <button type="button" class="quick-action-btn" id="remove-select-summative"><i class="fas fa-clipboard-check"></i> Summative Only</button>
      </div>
      
      <!-- Week Selection List -->
      <div class="sync-week-list" id="remove-week-list">
        <!-- Dynamically populated -->
      </div>
      
      <!-- Summary -->
      <div class="sync-summary remove-summary" id="remove-summary">
        <span class="sync-summary-count"><span id="remove-selected-count">0</span> items selected for removal</span>
      </div>
    </div>
    
    <div class="calendar-action-modal-footer">
      <button type="button" class="modal-btn secondary" id="cancel-selective-remove">Cancel</button>
      <button type="button" class="modal-btn danger" id="confirm-selective-remove"><i class="fas fa-trash-alt"></i> Remove Selected</button>
    </div>
  </div>
</div>

<!-- Embed school calendar as application/json to avoid Liquid template lint errors -->
{% assign calendar = site.data.school_calendar %}
<script id="school-calendar-json" type="application/json">
{
  "schoolYear": {{ calendar.school_year | jsonify }},
  "firstDay": {{ calendar.first_day | jsonify }},
  "lastDay": {{ calendar.last_day | jsonify }},
  "weeks": {
    {% for week in calendar.weeks %}
    "{{ week[0] }}": {
      "monday": {{ week[1].monday | jsonify }},
      "friday": {{ week[1].friday | jsonify }},
      "tuesday": {{ week[1].tuesday | default: nil | jsonify }},
      "holidays": {{ week[1].holidays | default: nil | jsonify }},
      "holidayAdjustment": {{ week[1].holiday_adjustment | default: nil | jsonify }},
      "skipWeek": {{ week[1].skip_week | default: false | jsonify }},
      "theme": {{ week[1].theme | default: nil | jsonify }},
      "notes": {{ week[1].notes | default: nil | jsonify }}
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  }
}
</script>

<script>
  // ============================= 
  //   SCHOOL CALENDAR SYSTEM     
  // ============================= 
  
  // School Calendar data is loaded from JSON script tag to avoid Liquid template lint errors
  let SCHOOL_CALENDAR = {};
  try {
    const calendarEl = document.getElementById('school-calendar-json');
    if (calendarEl && calendarEl.textContent) {
      SCHOOL_CALENDAR = JSON.parse(calendarEl.textContent);
    }
  } catch (e) {
    console.warn('Unable to parse SCHOOL_CALENDAR, falling back to empty object', e);
    SCHOOL_CALENDAR = { weeks: {} };
  }
  
  // Helper function to find the next valid school week (skipping break weeks)
  function getNextValidSchoolWeek(startWeekNum) {
    let weekNum = startWeekNum;
    const maxWeeks = 50; // Safety limit
    while (weekNum < maxWeeks) {
      const week = SCHOOL_CALENDAR.weeks[weekNum];
      if (!week) return null;
      if (!week.skipWeek) return weekNum;
      weekNum++;
    }
    return null;
  }
  
  // Helper function to check if a week is a school day (not a skip week)
  function isSchoolWeek(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    return week && !week.skipWeek;
  }
  
  const SPRINT_DATES_STORAGE_KEY = 'sprintDates';
  
  // Get calendar week data directly - sprint weeks ARE calendar weeks
  // The skip_week property is used to show warnings, not to remap weeks
  function getCalendarWeek(weekNum) {
    return SCHOOL_CALENDAR.weeks[weekNum] || null;
  }
  
  // Check if a calendar week is a break/skip week
  function isSkipWeek(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    return week && week.skipWeek === true;
  }
  
  // Get the appropriate date for reading materials (Monday or Tuesday if holiday)
  function getReadingDate(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    if (!week) return null;
    
    // Skip weeks should not return dates (they're breaks)
    if (week.skipWeek) return null;
    
    // If Monday is a holiday, use Tuesday
    if (week.holidayAdjustment === 'tuesday' && week.tuesday) {
      return week.tuesday;
    }
    return week.monday;
  }
  
  // Get the Friday date for assessments
  function getAssessmentDate(weekNum) {
    const week = SCHOOL_CALENDAR.weeks[weekNum];
    if (!week) return null;
    
    // Skip weeks should not return dates (they're breaks)
    if (week.skipWeek) return null;
    
    return week.friday;
  }
  
  // Get the Tuesday of the NEXT valid school week for checkpoints
  function getCheckpointDate(weekNum) {
    // Find next valid school week after the given week
    let nextWeekNum = weekNum + 1;
    const maxWeeks = 50;
    
    // Skip any break weeks to find the next valid school week
    while (nextWeekNum < maxWeeks) {
      const week = SCHOOL_CALENDAR.weeks[nextWeekNum];
      if (!week) return null;
      if (!week.skipWeek) {
        // Calculate Tuesday from Monday (add 1 day)
        const monday = new Date(week.monday);
        monday.setDate(monday.getDate() + 1);
        return monday.toISOString().split('T')[0];
      }
      nextWeekNum++;
    }
    return null;
  }
  
  // Format date for display
  function formatDateDisplay(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  
  function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  
  // Get the date range for a sprint based on week numbers
  // Sprint weeks directly correspond to calendar weeks
  function getSprintDateRange(startWeek, endWeek) {
    const startWeekData = SCHOOL_CALENDAR.weeks[startWeek];
    const endWeekData = SCHOOL_CALENDAR.weeks[endWeek];
    
    if (!startWeekData || !endWeekData) {
      return { start: null, end: null };
    }
    
    return {
      start: startWeekData.monday,
      end: endWeekData.friday
    };
  }
  
  // Populate the sprint date preview with actual calendar dates
  function populateSprintDatePreview(sprintKey, startWeek, endWeek) {
    const previewEl = document.querySelector(`.sprint-date-preview[data-sprint="${sprintKey}"]`);
    if (!previewEl) return;
    
    const dateRange = getSprintDateRange(startWeek, endWeek);
    
    let html = '';
    if (dateRange.start && dateRange.end) {
      html = `
        <div class="date-range-display">
          <span class="date-label">Start:</span> 
          <span class="date-value">${formatDateDisplay(dateRange.start)}</span>
        </div>
        <div class="date-range-display">
          <span class="date-label">End:</span> 
          <span class="date-value">${formatDateDisplay(dateRange.end)}</span>
        </div>
      `;
      
      // Show any break weeks that fall within this sprint range
      const breakWeeks = [];
      for (let w = startWeek; w <= endWeek; w++) {
        const week = SCHOOL_CALENDAR.weeks[w];
        if (week && week.skipWeek && week.holidays) {
          breakWeeks.push({ week: w, holidays: week.holidays });
        }
      }
      
      if (breakWeeks.length > 0) {
        html += '<div class="holiday-warnings">';
        breakWeeks.forEach(b => {
          html += `<div class="holiday-notice break"><i class="fas fa-umbrella-beach"></i> Week ${b.week}: ${b.holidays.join(', ')} (no school)</div>`;
        });
        html += '</div>';
      }
      
      // Show holiday warnings (non-skip weeks with holidays - materials on Tuesday)
      const holidays = [];
      for (let w = startWeek; w <= endWeek; w++) {
        const week = SCHOOL_CALENDAR.weeks[w];
        if (week && week.holidays && !week.skipWeek) {
          holidays.push({ week: w, holidays: week.holidays });
        }
      }
      
      if (holidays.length > 0) {
        html += '<div class="holiday-warnings">';
        holidays.forEach(h => {
          html += `<div class="holiday-notice"><i class="fas fa-exclamation-triangle"></i> Week ${h.week}: ${h.holidays.join(', ')} - Materials on Tuesday</div>`;
        });
        html += '</div>';
      }
    } else {
      html = '<div class="date-error">Calendar dates not available for these weeks</div>';
    }
    
    previewEl.innerHTML = html;
  }
  
  // Initialize sprint calendar controls
  async function initializeSprintDates() {
    // Populate all sprint date previews
    document.querySelectorAll('.sync-sprint-calendar-btn').forEach(btn => {
      const sprintKey = btn.dataset.sprint;
      const startWeek = parseInt(btn.dataset.startWeek);
      const endWeek = parseInt(btn.dataset.endWeek);
      populateSprintDatePreview(sprintKey, startWeek, endWeek);
    });
    
    // Toggle dropdown visibility
    document.querySelectorAll('.sprint-btn.date-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const dropdown = document.querySelector(`.sprint-date-dropdown[data-sprint="${sprintKey}"]`);
        
        // Close all other dropdowns
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          if (d !== dropdown) d.classList.add('hidden');
        });
        
        dropdown.classList.toggle('hidden');
      });
    });
    
    // Close dropdown buttons
    document.querySelectorAll('.date-dropdown-close').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        btn.closest('.sprint-date-dropdown').classList.add('hidden');
      });
    });
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.sprint-date-control')) {
        document.querySelectorAll('.sprint-date-dropdown').forEach(d => {
          d.classList.add('hidden');
        });
      }
    });
    
    // Sync button handlers - direct sync (original functionality)
    document.querySelectorAll('.sync-sprint-calendar-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        await syncSprintToCalendar(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Advanced sync button handlers - open selective sync modal
    document.querySelectorAll('.advanced-sync-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        openSelectiveSyncModal(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Delete button handlers - direct delete (original functionality)
    document.querySelectorAll('.delete-sprint-calendar-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        await deleteSprintFromCalendar(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Advanced remove button handlers - open selective remove modal
    document.querySelectorAll('.advanced-remove-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const sprintKey = btn.dataset.sprint;
        const course = btn.dataset.course;
        const startWeek = parseInt(btn.dataset.startWeek);
        const endWeek = parseInt(btn.dataset.endWeek);
        
        openSelectiveRemoveModal(sprintKey, course, startWeek, endWeek);
      });
    });
    
    // Initialize selective sync/remove modal handlers
    initializeSelectiveSyncModals();
  }
  
  // Main function to sync sprint to calendar
  async function syncSprintToCalendar(sprintKey, course, startWeek, endWeek) {
    const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
    const btn = document.querySelector(`.sync-sprint-calendar-btn[data-sprint="${sprintKey}"]`);
    
    // Get sync options (Checkpoints are added manually by instructor, not synced here)
    const syncFormative = document.querySelector(`.sync-reading-materials[data-sprint="${sprintKey}"]`)?.checked ?? true;
    const syncSummative = document.querySelector(`.sync-assessments[data-sprint="${sprintKey}"]`)?.checked ?? true;

    // Get selected priority level (default to P2 if none selected)
    const priorityRadio = document.querySelector(`input[name="priority-${sprintKey}"]:checked`);
    const priority = priorityRadio?.value || 'P2';
    
    btn.disabled = true;
    showDateStatus(statusEl, 'Syncing to calendar...', 'loading');
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      // Get sprint info
      const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
      const courseName = course.toUpperCase();
      
      const events = [];
      
      // Process each week in the sprint (no sprint start/end events - only calendar items)
      const weekCards = sprintCard?.querySelectorAll('.week-card') || [];
      
      for (const weekCard of weekCards) {
        const weekNum = parseInt(weekCard.dataset.week);
        const lessons = weekCard.dataset.lessons || '';
        const assignments = weekCard.dataset.assignments || '';
        
        const readingDate = getReadingDate(weekNum);
        const assessmentDate = getAssessmentDate(weekNum);
        
        // MONDAY (or Tuesday if holiday): FORMATIVE - All reading materials/lessons for the week
        if (syncFormative && readingDate) {
          // Get all lesson titles and URLs for this week
          const lessonList = lessons.split(';;;').filter(l => l.trim());
          
          // Remove duplicates (same title)
          const uniqueLessons = [];
          const seenTitles = new Set();
          for (const l of lessonList) {
            const [title] = l.split('|||');
            if (!seenTitles.has(title)) {
              seenTitles.add(title);
              uniqueLessons.push(l);
            }
          }
          
          if (uniqueLessons.length > 0) {
            // Create ONE formative event with all lessons listed
            const lessonItems = uniqueLessons.map(l => {
              const [title, url] = l.split('|||');
              const fullUrl = url ? window.location.origin + '{{ site.baseurl }}' + url : '';
              return `â€¢ ${title}${fullUrl ? '\n  ' + fullUrl : ''}`;
            }).join('\n\n');
            
            events.push({
              title: `[${priority}] ðŸ“š Week ${weekNum} Formative - ${courseName}`,
              description: `Reading Materials:\n\n${lessonItems}`,
              date: readingDate,
              period: courseName,
              priority: priority
            });
          }
        }
        
        // FRIDAY: SUMMATIVE - All assessments for the week
        // Note: Checkpoints are manually added by instructors through the calendar UI
        if (syncSummative && assessmentDate && assignments) {
          const assignmentList = assignments.split(';;;').filter(a => a.trim());
          
          // Remove duplicates (same title)
          const uniqueAssignments = [];
          const seenTitles = new Set();
          for (const a of assignmentList) {
            const [title] = a.split('|||');
            if (!seenTitles.has(title)) {
              seenTitles.add(title);
              uniqueAssignments.push(a);
            }
          }
          
          if (uniqueAssignments.length > 0) {
            // Create ONE summative event with all assignments listed
            const assignmentItems = uniqueAssignments.map(a => {
              const [title, url] = a.split('|||');
              const fullUrl = url ? window.location.origin + '{{ site.baseurl }}' + url : '';
              return `â€¢ ${title}${fullUrl ? '\n  ' + fullUrl : ''}`;
            }).join('\n\n');
            
            events.push({
              title: `[${priority}] ðŸ“ Week ${weekNum} Summative - ${courseName}`,
              description: `Assessments Due:\n\n${assignmentItems}`,
              date: assessmentDate,
              period: courseName,
              priority: priority
            });
          }
        }
        
        // Checkpoints are added manually by instructor via calendar UI, not auto-synced
      }
      
      // Check if we have any events to sync
      if (events.length === 0) {
        showDateStatus(statusEl, 'No events to sync for this sprint', 'warning');
        btn.disabled = false;
        return;
      }
      
      // Send all events to calendar API
      console.log(`Adding ${events.length} events to calendar for ${sprintKey}`);
      console.log('Events:', events);
      
      // Send individual requests in parallel
      let successCount = 0;
      try {
        const results = await Promise.all(
          events.map(event => 
            fetch(`${javaURI}/api/calendar/add_event`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(event)
            }).then(res => res.ok).catch(() => false)
          )
        );
        successCount = results.filter(r => r).length;
      } catch (err) {
        console.error('Error adding events:', err);
      }
      
      console.log(`Successfully added ${successCount}/${events.length} events`);
      
      if (successCount === events.length) {
        showDateStatus(statusEl, `âœ“ Added ${successCount} events to calendar!`, 'success');
      } else if (successCount > 0) {
        showDateStatus(statusEl, `âš  Added ${successCount}/${events.length} events`, 'warning');
      } else {
        showDateStatus(statusEl, 'âœ— Failed to add events. Are you logged in?', 'error');
      }
      
    } catch (error) {
      console.error('Error syncing sprint to calendar:', error);
      showDateStatus(statusEl, 'Error syncing to calendar', 'error');
    } finally {
      btn.disabled = false;
    }
  }
  
  // Main function to delete sprint events from calendar
  async function deleteSprintFromCalendar(sprintKey, course, startWeek, endWeek) {
    const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
    const btn = document.querySelector(`.delete-sprint-calendar-btn[data-sprint="${sprintKey}"]`);
    
    // Confirm before deleting
    const courseName = course.toUpperCase();
    const confirmMessage = `Are you sure you want to remove all ${courseName} events for ${sprintKey} (Weeks ${startWeek}-${endWeek}) from your calendar?`;
    if (!confirm(confirmMessage)) {
      return;
    }
    
    btn.disabled = true;
    showDateStatus(statusEl, 'Removing events from calendar...', 'loading');
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      // Get sprint info
      const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
      
      // Build list of event titles to delete (matching what was synced)
      const eventTitlesToDelete = [];
      const weekCards = sprintCard?.querySelectorAll('.week-card') || [];
      
      for (const weekCard of weekCards) {
        const weekNum = parseInt(weekCard.dataset.week);

        // Formative event title patterns (with all priority levels)
        ['P0', 'P1', 'P2', 'P3'].forEach(p => {
          eventTitlesToDelete.push(`[${p}] ðŸ“š Week ${weekNum} Formative - ${courseName}`);
          eventTitlesToDelete.push(`[${p}] ðŸ“ Week ${weekNum} Summative - ${courseName}`);
        });
        // Also include old format without priority for backwards compatibility
        eventTitlesToDelete.push(`ðŸ“š Week ${weekNum} Formative - ${courseName}`);
        
        // Summative event title pattern
        eventTitlesToDelete.push(`ðŸ“ Week ${weekNum} Summative - ${courseName}`);
      }
      
      console.log(`Deleting ${eventTitlesToDelete.length} potential events for ${sprintKey}`);
      console.log('Event titles to delete:', eventTitlesToDelete);
      
      let deletedCount = 0;
      
      // Try bulk delete endpoint first
      try {
        const bulkResponse = await fetch(`${javaURI}/api/calendar/delete_events`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ titles: eventTitlesToDelete })
        });
        
        if (bulkResponse.ok) {
          const result = await bulkResponse.json();
          deletedCount = result.deleted || 0;
        } else if (bulkResponse.status === 404) {
          // Bulk endpoint not available, fall back to individual deletes
          console.log('Bulk delete endpoint not available, using individual requests');
          const results = await Promise.all(
            eventTitlesToDelete.map(title => 
              fetch(`${javaURI}/api/calendar/delete_event`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ title: title })
              }).then(res => res.ok ? 1 : 0).catch(() => 0)
            )
          );
          deletedCount = results.reduce((a, b) => a + b, 0);
        } else {
          console.error('Failed to delete events:', bulkResponse.status);
        }
      } catch (err) {
        console.error('Error deleting events:', err);
      }
      
      console.log(`Successfully deleted ${deletedCount} events`);
      
      if (deletedCount > 0) {
        showDateStatus(statusEl, `âœ“ Removed ${deletedCount} events from calendar!`, 'success');
      } else {
        showDateStatus(statusEl, 'âš  No events found to remove', 'warning');
      }
      
    } catch (error) {
      console.error('Error deleting sprint from calendar:', error);
      showDateStatus(statusEl, 'Error removing from calendar', 'error');
    } finally {
      btn.disabled = false;
    }
  }
  
  // Show status message
  function showDateStatus(el, message, type) {
    if (!el) return;
    el.textContent = message;
    el.className = 'sprint-date-status ' + type;
    
    if (type === 'success' || type === 'error' || type === 'warning') {
      setTimeout(() => {
        el.textContent = '';
        el.className = 'sprint-date-status';
      }, 5000);
    }
  }
  
  // Show toast notification (visible overlay message)
  function showToastNotification(message, type) {
    // Remove existing toast if present
    const existingToast = document.querySelector('.calendar-toast-notification');
    if (existingToast) {
      existingToast.remove();
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `calendar-toast-notification ${type}`;
    toast.innerHTML = `
      <span class="toast-message">${message}</span>
      <button class="toast-close">&times;</button>
    `;
    
    // Add to page
    document.body.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Close button handler
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    });
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  }

  // ========================================
  // SELECTIVE SYNC/REMOVE MODAL SYSTEM
  // ========================================
  
  let currentSyncModalData = null;
  let currentRemoveModalData = null;
  
  // Parse week items from week card data attributes
  function parseWeekItems(weekCard) {
    const weekNum = parseInt(weekCard.dataset.week);
    const lessons = weekCard.dataset.lessons || '';
    const assignments = weekCard.dataset.assignments || '';
    
    const items = [];
    
    // Parse lessons (formative)
    if (lessons) {
      const lessonList = lessons.split(';;;').filter(l => l.trim());
      const seenTitles = new Set();
      lessonList.forEach(l => {
        const [title, url] = l.split('|||');
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          items.push({
            id: `w${weekNum}-formative-${title.replace(/\s+/g, '-').toLowerCase()}`,
            title: title,
            url: url,
            type: 'formative',
            weekNum: weekNum,
            day: 'Monday'
          });
        }
      });
    }
    
    // Parse assignments (summative)
    if (assignments) {
      const assignmentList = assignments.split(';;;').filter(a => a.trim());
      const seenTitles = new Set();
      assignmentList.forEach(a => {
        const [title, url] = a.split('|||');
        if (!seenTitles.has(title)) {
          seenTitles.add(title);
          items.push({
            id: `w${weekNum}-summative-${title.replace(/\s+/g, '-').toLowerCase()}`,
            title: title,
            url: url,
            type: 'summative',
            weekNum: weekNum,
            day: 'Friday'
          });
        }
      });
    }
    
    return items;
  }
  
  // Build week selection HTML for modal
  function buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, modalType) {
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const weekCards = sprintCard?.querySelectorAll('.week-card') || [];
    const courseName = course.toUpperCase();
    
    let html = '';
    
    for (const weekCard of weekCards) {
      const weekNum = parseInt(weekCard.dataset.week);
      const items = parseWeekItems(weekCard);
      
      if (items.length === 0) continue;
      
      const formativeItems = items.filter(i => i.type === 'formative');
      const summativeItems = items.filter(i => i.type === 'summative');
      
      const readingDate = getReadingDate(weekNum);
      const assessmentDate = getAssessmentDate(weekNum);
      
      // Check for warnings
      const calendarWeek = SCHOOL_CALENDAR.weeks[weekNum];
      const isSkip = calendarWeek?.skipWeek;
      const hasHoliday = calendarWeek?.holidays && !isSkip;
      const isPastDate = readingDate && new Date(readingDate) < new Date();
      
      html += `
        <div class="sync-week-group" data-week="${weekNum}">
          <div class="sync-week-header">
            <label class="sync-week-checkbox">
              <input type="checkbox" class="week-select-all" data-week="${weekNum}" checked>
              <span class="week-label">
                <strong>Week ${weekNum}</strong>
                <span class="week-date-range">${readingDate ? formatDateShort(readingDate) : ''} - ${assessmentDate ? formatDateShort(assessmentDate) : ''}</span>
              </span>
            </label>
            <button type="button" class="week-expand-btn" data-week="${weekNum}">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
          
          ${isSkip ? `<div class="sync-item-warning skip"><i class="fas fa-umbrella-beach"></i> Break week - ${calendarWeek.holidays?.join(', ') || 'No school'}</div>` : ''}
          ${hasHoliday ? `<div class="sync-item-warning holiday"><i class="fas fa-exclamation-triangle"></i> Holiday: ${calendarWeek.holidays?.join(', ')} - Materials on Tuesday</div>` : ''}
          ${isPastDate ? `<div class="sync-item-warning past"><i class="fas fa-clock"></i> This week's dates have already passed</div>` : ''}
          
          <div class="sync-week-items" data-week="${weekNum}">
            ${formativeItems.length > 0 ? `
              <div class="sync-item-category">
                <div class="sync-category-header">
                  <label class="sync-category-checkbox">
                    <input type="checkbox" class="category-select-all" data-week="${weekNum}" data-type="formative" checked>
                    <i class="fas fa-book"></i> Formative (${readingDate ? formatDateShort(readingDate) : 'Monday'})
                  </label>
                </div>
                <div class="sync-item-list">
                  ${formativeItems.map(item => `
                    <label class="sync-item-checkbox">
                      <input type="checkbox" class="item-checkbox" data-week="${weekNum}" data-type="formative" data-id="${item.id}" data-title="${item.title}" data-url="${item.url || ''}" checked>
                      <span class="item-title">${item.title}</span>
                      ${item.url ? `<a href="{{ site.baseurl }}${item.url}" target="_blank" class="item-link-icon" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </label>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            ${summativeItems.length > 0 ? `
              <div class="sync-item-category">
                <div class="sync-category-header">
                  <label class="sync-category-checkbox">
                    <input type="checkbox" class="category-select-all" data-week="${weekNum}" data-type="summative" checked>
                    <i class="fas fa-clipboard-check"></i> Summative (${assessmentDate ? formatDateShort(assessmentDate) : 'Friday'})
                  </label>
                </div>
                <div class="sync-item-list">
                  ${summativeItems.map(item => `
                    <label class="sync-item-checkbox">
                      <input type="checkbox" class="item-checkbox" data-week="${weekNum}" data-type="summative" data-id="${item.id}" data-title="${item.title}" data-url="${item.url || ''}" checked>
                      <span class="item-title">${item.title}</span>
                      ${item.url ? `<a href="{{ site.baseurl }}${item.url}" target="_blank" class="item-link-icon" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i></a>` : ''}
                    </label>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    return html || '<p class="no-items-message">No items found for this sprint.</p>';
  }
  
  // Open selective sync modal
  function openSelectiveSyncModal(sprintKey, course, startWeek, endWeek) {
    currentSyncModalData = { sprintKey, course, startWeek, endWeek };
    
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const sprintTitle = sprintCard?.querySelector('.sprint-title')?.textContent || sprintKey;
    const courseName = course.toUpperCase();
    
    // Set header info
    document.getElementById('sync-modal-sprint-name').textContent = `${sprintTitle} - ${courseName}`;
    const dateRange = getSprintDateRange(startWeek, endWeek);
    document.getElementById('sync-modal-date-range').textContent = 
      dateRange.start && dateRange.end 
        ? `${formatDateDisplay(dateRange.start)} - ${formatDateDisplay(dateRange.end)}`
        : `Weeks ${startWeek}-${endWeek}`;
    
    // Build week selection list
    document.getElementById('sync-week-list').innerHTML = buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, 'sync');
    
    // Check for existing events and show warnings
    checkForExistingEvents(sprintKey, course, startWeek, endWeek);
    
    // Initialize checkbox handlers for this modal
    initializeSyncModalCheckboxes('sync');
    
    // Update count
    updateSelectedCount('sync');
    
    // Close the dropdown
    document.querySelectorAll('.sprint-date-dropdown').forEach(d => d.classList.add('hidden'));
    
    // Show modal
    document.getElementById('selective-sync-modal').style.display = 'flex';
  }
  
  // Open selective remove modal
  function openSelectiveRemoveModal(sprintKey, course, startWeek, endWeek) {
    currentRemoveModalData = { sprintKey, course, startWeek, endWeek };
    
    const sprintCard = document.querySelector(`.sprint-card[data-sprint="${sprintKey}"]`);
    const sprintTitle = sprintCard?.querySelector('.sprint-title')?.textContent || sprintKey;
    const courseName = course.toUpperCase();
    
    // Set header info
    document.getElementById('remove-modal-sprint-name').textContent = `${sprintTitle} - ${courseName}`;
    const dateRange = getSprintDateRange(startWeek, endWeek);
    document.getElementById('remove-modal-date-range').textContent = 
      dateRange.start && dateRange.end 
        ? `${formatDateDisplay(dateRange.start)} - ${formatDateDisplay(dateRange.end)}`
        : `Weeks ${startWeek}-${endWeek}`;
    
    // Build week selection list
    document.getElementById('remove-week-list').innerHTML = buildWeekSelectionHTML(sprintKey, course, startWeek, endWeek, 'remove');
    
    // Initialize checkbox handlers for this modal
    initializeSyncModalCheckboxes('remove');
    
    // Update count
    updateSelectedCount('remove');
    
    // Close the dropdown
    document.querySelectorAll('.sprint-date-dropdown').forEach(d => d.classList.add('hidden'));
    
    // Show modal
    document.getElementById('selective-remove-modal').style.display = 'flex';
  }
  
  // Check for existing events on the calendar
  async function checkForExistingEvents(sprintKey, course, startWeek, endWeek) {
    const warningsContainer = document.getElementById('sync-warnings-container');
    warningsContainer.innerHTML = '<div class="checking-events"><i class="fas fa-spinner fa-spin"></i> Checking for existing events...</div>';
    warningsContainer.classList.remove('hidden');
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      const courseName = course.toUpperCase();
      
      // Build list of event titles we're about to sync
      const eventTitlesToCheck = [];
      const priorities = ['P0', 'P1', 'P2', 'P3'];
      
      for (let weekNum = startWeek; weekNum <= endWeek; weekNum++) {
        priorities.forEach(p => {
          eventTitlesToCheck.push(`[${p}] ðŸ“š Week ${weekNum} Formative - ${courseName}`);
          eventTitlesToCheck.push(`[${p}] ðŸ“ Week ${weekNum} Summative - ${courseName}`);
        });
        // Also check old format
        eventTitlesToCheck.push(`ðŸ“š Week ${weekNum} Formative - ${courseName}`);
        eventTitlesToCheck.push(`ðŸ“ Week ${weekNum} Summative - ${courseName}`);
      }
      
      // Note: Duplicate checking not available - events will be created/updated as needed
      // The backend handles duplicates by matching on title and date
      warningsContainer.innerHTML = '';
      warningsContainer.classList.add('hidden');
    } catch (error) {
      console.log('Could not check for existing events:', error);
      warningsContainer.innerHTML = '';
      warningsContainer.classList.add('hidden');
    }
  }
  
  // Initialize checkbox event handlers within modal
  function initializeSyncModalCheckboxes(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const listEl = document.getElementById(listId);
    
    // Week expand/collapse
    listEl.querySelectorAll('.week-expand-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const weekNum = btn.dataset.week;
        const itemsContainer = listEl.querySelector(`.sync-week-items[data-week="${weekNum}"]`);
        const icon = btn.querySelector('i');
        
        if (itemsContainer.classList.contains('collapsed')) {
          itemsContainer.classList.remove('collapsed');
          icon.classList.remove('fa-chevron-right');
          icon.classList.add('fa-chevron-down');
        } else {
          itemsContainer.classList.add('collapsed');
          icon.classList.remove('fa-chevron-down');
          icon.classList.add('fa-chevron-right');
        }
      });
    });
    
    // Week select all checkbox
    listEl.querySelectorAll('.week-select-all').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const isChecked = checkbox.checked;
        
        // Update all items in this week
        listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        // Update category checkboxes
        listEl.querySelectorAll(`.category-select-all[data-week="${weekNum}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        updateSelectedCount(modalType);
      });
    });
    
    // Category select all checkbox
    listEl.querySelectorAll('.category-select-all').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const type = checkbox.dataset.type;
        const isChecked = checkbox.checked;
        
        // Update all items in this category
        listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]`).forEach(cb => {
          cb.checked = isChecked;
        });
        
        // Update week checkbox
        updateWeekCheckboxState(listEl, weekNum);
        updateSelectedCount(modalType);
      });
    });
    
    // Individual item checkbox
    listEl.querySelectorAll('.item-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const weekNum = checkbox.dataset.week;
        const type = checkbox.dataset.type;
        
        // Update category checkbox
        updateCategoryCheckboxState(listEl, weekNum, type);
        
        // Update week checkbox
        updateWeekCheckboxState(listEl, weekNum);
        
        updateSelectedCount(modalType);
      });
    });
  }
  
  // Update category checkbox state based on items
  function updateCategoryCheckboxState(listEl, weekNum, type) {
    const categoryCheckbox = listEl.querySelector(`.category-select-all[data-week="${weekNum}"][data-type="${type}"]`);
    if (!categoryCheckbox) return;
    
    const items = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]`);
    const checkedItems = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"][data-type="${type}"]:checked`);
    
    categoryCheckbox.checked = checkedItems.length === items.length;
    categoryCheckbox.indeterminate = checkedItems.length > 0 && checkedItems.length < items.length;
  }
  
  // Update week checkbox state based on all items
  function updateWeekCheckboxState(listEl, weekNum) {
    const weekCheckbox = listEl.querySelector(`.week-select-all[data-week="${weekNum}"]`);
    if (!weekCheckbox) return;
    
    const items = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]`);
    const checkedItems = listEl.querySelectorAll(`.item-checkbox[data-week="${weekNum}"]:checked`);
    
    weekCheckbox.checked = checkedItems.length === items.length;
    weekCheckbox.indeterminate = checkedItems.length > 0 && checkedItems.length < items.length;
  }
  
  // Update selected count display
  function updateSelectedCount(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const countId = modalType === 'sync' ? 'sync-selected-count' : 'remove-selected-count';
    
    const listEl = document.getElementById(listId);
    const checkedItems = listEl.querySelectorAll('.item-checkbox:checked');
    
    document.getElementById(countId).textContent = checkedItems.length;
  }
  
  // Get selected items from modal
  function getSelectedItems(modalType) {
    const listId = modalType === 'sync' ? 'sync-week-list' : 'remove-week-list';
    const listEl = document.getElementById(listId);
    
    const selectedItems = [];
    const itemsByWeek = {};
    
    listEl.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
      const weekNum = parseInt(checkbox.dataset.week);
      const type = checkbox.dataset.type;
      const title = checkbox.dataset.title;
      const url = checkbox.dataset.url;
      
      if (!itemsByWeek[weekNum]) {
        itemsByWeek[weekNum] = { formative: [], summative: [] };
      }
      
      itemsByWeek[weekNum][type].push({ title, url });
    });
    
    return itemsByWeek;
  }
  
  // Execute selective sync
  async function executeSelectiveSync() {
    if (!currentSyncModalData) return;
    
    const { sprintKey, course, startWeek, endWeek } = currentSyncModalData;
    const selectedItems = getSelectedItems('sync');
    const priority = document.querySelector('input[name="sync-modal-priority"]:checked')?.value || 'P2';
    const duplicateAction = document.querySelector('input[name="duplicate-action"]:checked')?.value || 'update';
    
    const courseName = course.toUpperCase();
    const confirmBtn = document.getElementById('confirm-selective-sync');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      const events = [];
      
      Object.keys(selectedItems).forEach(weekNum => {
        const weekData = selectedItems[weekNum];
        const readingDate = getReadingDate(parseInt(weekNum));
        const assessmentDate = getAssessmentDate(parseInt(weekNum));
        
        // Build formative event if any items selected
        if (weekData.formative.length > 0 && readingDate) {
          const lessonItems = weekData.formative.map(item => {
            const fullUrl = item.url ? window.location.origin + '{{ site.baseurl }}' + item.url : '';
            return `â€¢ ${item.title}${fullUrl ? '\n  ' + fullUrl : ''}`;
          }).join('\n\n');
          
          events.push({
            title: `[${priority}] ðŸ“š Week ${weekNum} Formative - ${courseName}`,
            description: `Reading Materials:\n\n${lessonItems}`,
            date: readingDate,
            period: courseName,
            priority: priority
          });
        }
        
        // Build summative event if any items selected
        if (weekData.summative.length > 0 && assessmentDate) {
          const assignmentItems = weekData.summative.map(item => {
            const fullUrl = item.url ? window.location.origin + '{{ site.baseurl }}' + item.url : '';
            return `â€¢ ${item.title}${fullUrl ? '\n  ' + fullUrl : ''}`;
          }).join('\n\n');
          
          events.push({
            title: `[${priority}] ðŸ“ Week ${weekNum} Summative - ${courseName}`,
            description: `Assessments Due:\n\n${assignmentItems}`,
            date: assessmentDate,
            period: courseName,
            priority: priority
          });
        }
      });
      
      if (events.length === 0) {
        alert('No items selected to sync.');
        return;
      }
      
      console.log(`Syncing ${events.length} events to calendar`);
      
      let successCount = 0;
      
      // Send individual requests in parallel
      const results = await Promise.all(
        events.map(event => 
          fetch(`${javaURI}/api/calendar/add_event`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(event)
          }).then(res => res.ok).catch(() => false)
        )
      );
      successCount = results.filter(r => r).length;
      
      // Close modal and show status
      closeSelectiveSyncModal();
      
      // Show toast notification for visibility
      if (successCount === events.length) {
        showToastNotification(`âœ“ Synced ${successCount} events to calendar!`, 'success');
      } else if (successCount > 0) {
        showToastNotification(`âš  Synced ${successCount}/${events.length} events`, 'warning');
      } else {
        showToastNotification('âœ— Failed to sync events. Are you logged in?', 'error');
      }
      
      // Also update the dropdown status (visible when dropdown is opened)
      const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
      if (successCount === events.length) {
        showDateStatus(statusEl, `âœ“ Synced ${successCount} events to calendar!`, 'success');
      } else if (successCount > 0) {
        showDateStatus(statusEl, `âš  Synced ${successCount}/${events.length} events`, 'warning');
      } else {
        showDateStatus(statusEl, 'âœ— Failed to sync events. Are you logged in?', 'error');
      }
      
    } catch (error) {
      console.error('Error syncing:', error);
      alert('Error syncing to calendar. Please try again.');
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-sync"></i> Sync Selected';
    }
  }
  
  // Execute selective remove
  async function executeSelectiveRemove() {
    if (!currentRemoveModalData) return;
    
    const { sprintKey, course, startWeek, endWeek } = currentRemoveModalData;
    const selectedItems = getSelectedItems('remove');
    const courseName = course.toUpperCase();
    
    const confirmBtn = document.getElementById('confirm-selective-remove');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    
    try {
      const configModule = await import('{{ site.baseurl }}/assets/js/api/config.js');
      const javaURI = configModule.javaURI;
      
      const titlesToDelete = [];
      const priorities = ['P0', 'P1', 'P2', 'P3'];
      
      Object.keys(selectedItems).forEach(weekNum => {
        const weekData = selectedItems[weekNum];
        
        // Add formative event titles if any items selected
        if (weekData.formative.length > 0) {
          priorities.forEach(p => {
            titlesToDelete.push(`[${p}] ðŸ“š Week ${weekNum} Formative - ${courseName}`);
          });
          titlesToDelete.push(`ðŸ“š Week ${weekNum} Formative - ${courseName}`);
        }
        
        // Add summative event titles if any items selected
        if (weekData.summative.length > 0) {
          priorities.forEach(p => {
            titlesToDelete.push(`[${p}] ðŸ“ Week ${weekNum} Summative - ${courseName}`);
          });
          titlesToDelete.push(`ðŸ“ Week ${weekNum} Summative - ${courseName}`);
        }
      });
      
      if (titlesToDelete.length === 0) {
        alert('No items selected to remove.');
        return;
      }
      
      console.log(`Removing ${titlesToDelete.length} potential events from calendar`);
      
      let deletedCount = 0;
      
      const bulkResponse = await fetch(`${javaURI}/api/calendar/delete_events`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ titles: titlesToDelete })
      });
      
      if (bulkResponse.ok) {
        const result = await bulkResponse.json();
        deletedCount = result.deleted || 0;
      } else if (bulkResponse.status === 404) {
        const results = await Promise.all(
          titlesToDelete.map(title => 
            fetch(`${javaURI}/api/calendar/delete_event`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ title: title })
            }).then(res => res.ok ? 1 : 0).catch(() => 0)
          )
        );
        deletedCount = results.reduce((a, b) => a + b, 0);
      }
      
      // Close modal and show status
      closeSelectiveRemoveModal();
      
      // Show toast notification for visibility
      if (deletedCount > 0) {
        showToastNotification(`âœ“ Removed ${deletedCount} events from calendar!`, 'success');
      } else {
        showToastNotification('âš  No events found to remove', 'warning');
      }
      
      // Also update the dropdown status (visible when dropdown is opened)
      const statusEl = document.querySelector(`.sprint-date-status[data-sprint="${sprintKey}"]`);
      if (deletedCount > 0) {
        showDateStatus(statusEl, `âœ“ Removed ${deletedCount} events from calendar!`, 'success');
      } else {
        showDateStatus(statusEl, 'âš  No events found to remove', 'warning');
      }
      
    } catch (error) {
      console.error('Error removing:', error);
      alert('Error removing from calendar. Please try again.');
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Remove Selected';
    }
  }
  
  // Close modals
  function closeSelectiveSyncModal() {
    document.getElementById('selective-sync-modal').style.display = 'none';
    currentSyncModalData = null;
  }
  
  function closeSelectiveRemoveModal() {
    document.getElementById('selective-remove-modal').style.display = 'none';
    currentRemoveModalData = null;
  }
  
  // Initialize modal event handlers
  function initializeSelectiveSyncModals() {
    // Close buttons
    document.getElementById('close-selective-sync-modal')?.addEventListener('click', closeSelectiveSyncModal);
    document.getElementById('cancel-selective-sync')?.addEventListener('click', closeSelectiveSyncModal);
    document.getElementById('close-selective-remove-modal')?.addEventListener('click', closeSelectiveRemoveModal);
    document.getElementById('cancel-selective-remove')?.addEventListener('click', closeSelectiveRemoveModal);
    
    // Confirm buttons
    document.getElementById('confirm-selective-sync')?.addEventListener('click', executeSelectiveSync);
    document.getElementById('confirm-selective-remove')?.addEventListener('click', executeSelectiveRemove);
    
    // Quick action buttons - Sync modal
    document.getElementById('sync-select-all')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .category-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-deselect-all')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-select-formative')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('sync-week-list'), weekNum);
      });
      updateSelectedCount('sync');
    });
    
    document.getElementById('sync-select-summative')?.addEventListener('click', () => {
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#sync-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#sync-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('sync-week-list'), weekNum);
      });
      updateSelectedCount('sync');
    });
    
    // Quick action buttons - Remove modal
    document.getElementById('remove-select-all')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .category-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-deselect-all')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-select-formative')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('remove-week-list'), weekNum);
      });
      updateSelectedCount('remove');
    });
    
    document.getElementById('remove-select-summative')?.addEventListener('click', () => {
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="summative"]').forEach(cb => cb.checked = true);
      document.querySelectorAll('#remove-week-list .item-checkbox[data-type="formative"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="summative"]').forEach(cb => { cb.checked = true; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .category-select-all[data-type="formative"]').forEach(cb => { cb.checked = false; cb.indeterminate = false; });
      document.querySelectorAll('#remove-week-list .week-select-all').forEach(cb => {
        const weekNum = cb.dataset.week;
        updateWeekCheckboxState(document.getElementById('remove-week-list'), weekNum);
      });
      updateSelectedCount('remove');
    });
    
    // Close on outside click
    document.getElementById('selective-sync-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'selective-sync-modal') closeSelectiveSyncModal();
    });
    
    document.getElementById('selective-remove-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'selective-remove-modal') closeSelectiveRemoveModal();
    });
  }
</script>
