<style>
  * {
    box-sizing: border-box;
  }

  /* Floating Action Button */
  .admin-fab {
    position: fixed;
    right: 2rem;
    top: 9rem;
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    border: none;
    padding: 1rem 1.5rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(240, 147, 251, 0.15);
    transition: all 0.3s ease;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .admin-fab:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(240, 147, 251, 0.6);
  }

  /* Side Panel */
  .admin-panel {
    position: fixed;
    left: 50%;
    top: 50%;
    width: 720px;
    max-width: 95vw;
    height: 45vh;
    background: white;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);
    transition: transform 0.28s cubic-bezier(.4, 0, .2, 1),
      opacity 0.2s ease, visibility 0.2s ease;
    z-index: 1300;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transform: translate(-50%, -50%) scale(0.96);
    opacity: 0;
    visibility: hidden;
    border-radius: 12px;
  }

  .admin-panel.open {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    visibility: visible;
  }

  @media (max-width: 768px) {
    .admin-panel {
      width: 95vw;
      max-width: 95vw;
      height: 85vh;
      border-radius: 12px;
    }

    .admin-fab {
      right: 2rem;
      top: 9rem;
      bottom: auto;
      padding: 1rem 1.5rem;
    }
  }

  @media (min-width: 1024px) {
    .admin-panel {
      width: 1000px;
    }
  }

  .admin-panel-header {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .admin-close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .admin-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .admin-panel-title {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
  }

  .admin-panel-content {
    flex: 1;
    overflow: hidden;
    /* Prevent double scrollbars */
    padding: 20px;
    display: flex;
    /* Enable flex layout for children */
    flex-direction: column;
  }

  /* Responsive Table Container */
  #admin-container {
    overflow: auto;
    /* Handle both X and Y scrolling */
    width: 100%;
    flex: 1;
    /* Fill available height */
    display: block;
    -webkit-overflow-scrolling: touch;
    /* Smooth scrolling on iOS */
  }

  /* Table Styles */
  #admin-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  #admin-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  #admin-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    white-space: nowrap;
  }

  #admin-table td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }

  #admin-table tr:hover {
    background: #f9fafb;
  }

  /* Action Buttons */
  .action-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 6px;
    margin: 0 4px;
    border-radius: 4px;
    transition: background 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .action-btn:hover {
    background: #e5e7eb;
  }

  .action-btn svg {
    width: 18px;
    height: 18px;
    color: #6b7280;
  }

  .action-btn.delete:hover svg {
    color: #ef4444;
  }

  .action-btn.edit:hover svg {
    color: #3b82f6;
  }

  /* Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2147483647;
    /* ensure overlay sits above any transformed stacking contexts */
    -webkit-backdrop-filter: blur(2px);
    backdrop-filter: blur(2px);
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal-panel {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    width: calc(100% - 48px);
    max-width: 800px;
    /* increase height so modal can show more content without clipping */
    max-height: 92vh;
    height: auto;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 24px 28px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
  }

  .modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 28px;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .modal-body {
    padding: 28px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
    font-size: 15px;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 15px;
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
  }

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: #e5e7eb;
    color: #374151;
  }

  .btn-secondary:hover {
    background: #d1d5db;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  .status-active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-inactive {
    background: #fee2e2;
    color: #991b1b;
  }
</style>

<!-- Floating Admin Button -->
<button id="admin-toggle-btn" class="admin-fab" aria-label="Open Admin Panel">
  ⚙️ Admin
</button>

<!-- Admin Side Panel -->
<aside id="admin-panel" class="admin-panel" tabindex="-1" aria-label="Admin panel">
  <div class="admin-panel-header">
    <button id="admin-close-btn" class="admin-close-btn" aria-label="Close Admin Panel">&times;</button>
    <h2 class="admin-panel-title">Admin Dashboard</h2>
  </div>

  <div class="admin-panel-content">
    <div id="admin-container">
      <em>Loading admin data...</em>
    </div>
  </div>
</aside>

<!-- Edit/Create Modal -->
<div id="admin-modal" class="modal-overlay">
  <div class="modal-panel">
    <div class="modal-header">
      <button id="modal-close" class="modal-close" aria-label="Close Modal">&times;</button>
      <h2 id="modal-title" class="modal-title">Create User</h2>
    </div>
    <div class="modal-body">
      <form id="admin-form">
        <input type="hidden" id="user-id" name="id">

        <div class="form-group">
          <label for="username">Username <span style="color: red;">*</span></label>
          <input type="text" id="username" name="username" required>
        </div>

        <div class="form-group">
          <label for="email">Email <span style="color: red;">*</span></label>
          <input type="email" id="email" name="email" required>
        </div>

        <div class="form-group">
          <label for="role">Role</label>
          <select id="role" name="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
            <option value="moderator">Moderator</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script type="module">
  import { pythonURI, javaURI, fetchOptions } from '{{ site.baseurl }}/assets/js/api/config.js';
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', async function () {
    console.log("Admin panel script loaded.");

    async function getCredentials() {
      try {
        const res = await fetch(`${pythonURI}/api/id`, {
          ...fetchOptions,
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          },
        });

        if (res.ok) {
          const data = await res.json();
          const role = data.role;
          console.log(role);
          return role;
        } else {
          console.log(`Request failed for with status ${res.status}`);
        }
      } catch (err) {
        console.log(`Error: ${err}`);
      }
    }

    async function getGrades() {
      try {
        const res = await fetch(`${javaURI}/api/grades`, {
          ...fetchOptions,
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          },
        });

        if (res.ok) {
          const data = await res.json();
          console.log("In get grades function", data)
          return data;
        } else {
          console.log(`Request failed for with status ${res.status}`);
        }
      } catch (err) {
        console.log(`Error: ${err}`);
      }
    }

    const role = await getCredentials();
    const grades = await getGrades();

    // Admin panel open/close logic
    const adminPanel = document.getElementById('admin-panel');
    const adminFab = document.getElementById('admin-toggle-btn');
    const adminCloseBtn = document.getElementById('admin-close-btn');

    if (adminFab && adminPanel && adminCloseBtn) {
      adminFab.addEventListener('click', function () {
        adminPanel.classList.add('open');
        adminFab.style.display = 'none';
        console.log("Admin panel opened.");
        console.log("Role:", role);
        console.log("Grades:", grades);

        // Show a message if the current user is not an admin
        const container = document.getElementById('admin-container') || document.getElementById('admin-modal-content');

        if (!role || String(role) !== 'Admin') {
          container.innerHTML = '<p style="color:#de1010; font-size:16px;">This admin panel is only available to admin users.</p>';
          return;
        }

        // If user is admin, render a 7-column table (UID, Assignment, Score, Classes, Content, Notes, Link)
        if (role && String(role) === 'Admin') {
          // small helper to escape HTML
          function escapeHtml(str) {
            return String(str || '')
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
          }

          const container = document.getElementById('admin-container') || document.getElementById('admin-modal-content');
          if (!container) {
            console.warn('No admin container found to render admin table.');
            return;
          }

          // Define openPdfViewer function globally
          window.fileDataStore = {}; // Store file data here

          window.openPdfViewer = function (key, filename) {
            const base64Data = window.fileDataStore[key];
            if (!base64Data) {
              alert('Error: File data not found.');
              return;
            }

            const viewerWindow = window.open('', '_blank');
            if (viewerWindow) {
              const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                  <title>PDF Viewer - ${filename}</title>
                  <style>
                    body { margin: 0; background-color: #525659; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
                    .header { width: 100%; background: #333; color: white; padding: 10px; text-align: center; font-family: sans-serif; position: sticky; top: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100; }
                    .pdf-page { margin: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); background: white; display: block; }
                    #pdf-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
                  </style>
                </head>
                <body>
                  <div class="header">
                    <h2>Viewing: ${filename}</h2>
                  </div>
                  <div id="pdf-container"></div>
                  
                  <script type="module">
                    import * as pdfjsLib from 'https://mozilla.github.io/pdf.js/build/pdf.mjs';
                    
                    try {
                        var pdfData = atob('${base64Data}');
                        
                        // Set worker source
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.mjs';

                        var loadingTask = pdfjsLib.getDocument({data: pdfData});
                        loadingTask.promise.then(function(pdf) {
                          console.log('PDF loaded with ' + pdf.numPages + ' pages');
                          var container = document.getElementById('pdf-container');
                          
                          // Render all pages
                          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                              // Create canvas for each page immediately to maintain order
                              const canvas = document.createElement('canvas');
                              canvas.className = 'pdf-page';
                              container.appendChild(canvas);
                              
                              // Fetch and render the page
                              pdf.getPage(pageNum).then(function(page) {
                                console.log('Page ' + pageNum + ' loaded');
                                
                                var scale = 1.5;
                                var viewport = page.getViewport({scale: scale});

                                var context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;

                                var renderContext = {
                                  canvasContext: context,
                                  viewport: viewport
                                };
                                var renderTask = page.render(renderContext);
                                renderTask.promise.then(function () {
                                  console.log('Page ' + pageNum + ' rendered');
                                });
                              });
                          }
                        }, function (reason) {
                          console.error(reason);
                          document.body.innerHTML += '<p style="color:red; text-align:center; background:white; padding:10px;">Error loading PDF: ' + reason + '</p>';
                        });
                    } catch (e) {
                        console.error(e);
                        document.body.innerHTML += '<p style="color:red; text-align:center; background:white; padding:10px;">Error processing PDF data: ' + e.message + '</p>';
                    }
                  <\/script>
                </body>
                </html>
              `;
              viewerWindow.document.write(htmlContent);
              viewerWindow.document.close();
            } else {
              alert('Please allow popups to view the PDF.');
            }
          };

          // Function to download base64 file
          window.downloadBase64File = function (key, filename) {
            const base64Data = window.fileDataStore[key];
            if (!base64Data) {
              alert('Error: File data not found.');
              return;
            }

            // Simple mime type inference
            let mimeType = 'application/octet-stream';
            if (filename.endsWith('.png')) mimeType = 'image/png';
            else if (filename.endsWith('.jpg') || filename.endsWith('.jpeg')) mimeType = 'image/jpeg';
            else if (filename.endsWith('.txt')) mimeType = 'text/plain';

            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);

            for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
            }

            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: mimeType });

            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            a.click();

            URL.revokeObjectURL(url);
          };

          const rows = (Array.isArray(grades) ? grades : []).map((g, rowIndex) => {
            // Format content column
            let contentHtml = '';
            if (Array.isArray(g.content)) {
              contentHtml = g.content.map((c, contentIndex) => {
                const filename = escapeHtml(c.filename || 'unknown');
                const isPdf = filename.toLowerCase().endsWith('.pdf');
                const filePreview = c.file ? escapeHtml(c.file.substring(0, 10)) : '';

                let fileDisplay = `<span>${filename} (${filePreview})</span>`;

                if (c.file) {
                  // Generate unique key
                  const fileKey = `file_${g.uid || g.studentId}_${rowIndex}_${contentIndex}`;
                  // Store full base64 data
                  window.fileDataStore[fileKey] = c.file;

                  if (isPdf) {
                    fileDisplay += `
                        <button onclick="openPdfViewer('${fileKey}', '${filename}')" class="action-btn" title="View PDF">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                          </svg>
                        </button>
                       `;
                  } else {
                    // Download button for other file types
                    fileDisplay += `
                        <button onclick="downloadBase64File('${fileKey}', '${filename}')" class="action-btn" title="Download File">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                          </svg>
                        </button>
                       `;
                  }
                }

                return `<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">${fileDisplay}</div>`;
              }).join('');
            }

            // Helper to create safe CSS ID from string
            function safeId(str) {
              return String(str || '').replace(/[^a-zA-Z0-9-_]/g, '-');
            }

            // Format link column
            const linkHtml = g.link ? `<a href="${escapeHtml(g.link)}" target="_blank">${escapeHtml(g.link)}</a>` : '';

            return `\
            <tr>\
              <td>${escapeHtml(g.uid || g.studentId || '(unknown)')}</td>\
              <td>${escapeHtml(g.title || g.assignment)}</td>\
              <td id="score-${safeId(g.uid || g.studentId)}-${safeId(g.title || g.assignment)}">${escapeHtml(g.score)}</td>\
              <td>${escapeHtml(g.class || g.course || g.classes)}</td>\
              <td>${contentHtml}</td>\
              <td>${escapeHtml(g.notes)}</td>\
              <td>${linkHtml}</td>\
              <td>\
                <button class="action-btn edit" onclick="openEditModal('${escapeHtml(g.uid)}', '${escapeHtml(g.title || g.assignment)}')">\
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">\
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />\
                  </svg>\
                </button>\
              </td>\
            </tr>\
          `}).join('');

          const tableHtml = `\
            <table id="admin-table">\
              <thead>\
                <tr>\
                  <th>UID</th>\
                  <th>Assignment</th>\
                  <th>Score</th>\
                  <th>Classes</th>\
                  <th>Content</th>\
                  <th>Notes</th>\
                  <th>Link</th>\
                  <th>Actions</th>\
                </tr>\
              </thead>\
              <tbody>\
                ${rows}\
              </tbody>\
            </table>\
          `;

          container.innerHTML = tableHtml;

          // Define openEditModal function globally so it can be called from onclick
          window.openEditModal = async function (uid, title) {
            const score = prompt(`Enter new score for ${title} (UID: ${uid}):`);
            if (score !== null) {
              try {
                // Note: Trailing slash used based on previous fix experience
                const res = await fetch(`${javaURI}/api/grades`, {
                  ...fetchOptions,
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    uid: uid,
                    title: title,
                    score: score
                  })
                });

                if (res.ok) {
                  alert('Score updated successfully!');
                  // Reconstruct the safe ID
                  const safeUid = String(uid || '').replace(/[^a-zA-Z0-9-_]/g, '-');
                  const safeTitle = String(title || '').replace(/[^a-zA-Z0-9-_]/g, '-');
                  const scoreCell = document.getElementById(`score-${safeUid}-${safeTitle}`);

                  if (scoreCell) {
                    scoreCell.innerText = score;
                  }
                } else {
                  alert(`Failed to update score: ${res.status}`);
                  console.error('Update failed', res);
                }
              } catch (err) {
                console.error('Error updating score:', err);
                alert('Error updating score: ' + err.message);
              }
            }
          };
        }
      });

      adminCloseBtn.addEventListener('click', function () {
        adminPanel.classList.remove('open');
        adminFab.style.display = '';
      });
    }

    // Modal open/close logic
    const modal = document.getElementById('admin-modal');
    // If the include is rendered inside a transformed/overflowing container,
    // move the modal overlay into `document.body` so it can cover the full viewport
    // and avoid clipping by parent stacking contexts.
    if (modal && modal.parentElement !== document.body) {
      try {
        document.body.appendChild(modal);
      } catch (err) {
        console.warn('Could not move admin modal to body:', err);
      }
    }
    const modalClose = document.getElementById('modal-close');
    const cancelBtn = document.getElementById('cancel-btn');

    if (modalClose && modal) {
      modalClose.addEventListener('click', function () {
        modal.classList.remove('active');
      });
    }

    if (cancelBtn && modal) {
      cancelBtn.addEventListener('click', function () {
        modal.classList.remove('active');
      });
    }

    if (modal) {
      modal.addEventListener('click', function (e) {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    }

    // Form submission (placeholder)
    const adminForm = document.getElementById('admin-form');
    if (adminForm) {
      adminForm.addEventListener('submit', function (e) {
        e.preventDefault();
        console.log('Form submitted');
        if (modal) modal.classList.remove('active');
        // Add your form handling logic here
      });
    }
  });
</script>